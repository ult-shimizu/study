- name: yumがupdate済であること
  yum:
    name: '*'
    state: latest
    update_cache: yes

# Apache
- name: httpdがインストールされていること
  yum:
    name: httpd24
    state: present

- name: Apacheが起動してenableになっていること
  service:
    name: httpd
    state: started
    enabled: yes

- name: Prefork MPMが有効になっていること
  lineinfile:
    path: /etc/httpd/conf.modules.d/00-mpm.conf
    state: present
    backrefs: yes
    regexp: '^#(LoadModule mpm_prefork_module.*)$'
    line: '\1'
  notify: restart httpd

- name: Worker MPMが無効になっていること
  lineinfile:
    path: /etc/httpd/conf.modules.d/00-mpm.conf
    state: present
    backrefs: yes
    regexp: '^(LoadModule mpm_worker_module.*)$'
    line: '#\1'
  notify: restart httpd

- name: Event MPMが無効になっていること
  lineinfile:
    path: /etc/httpd/conf.modules.d/00-mpm.conf
    state: present
    backrefs: yes
    regexp: '^(LoadModule mpm_event_module.*)$'
    line: '#\1'
  notify: restart httpd

- name: DocumentRootが設定されていること
  replace:
    dest: /etc/httpd/conf/httpd.conf
    regexp: DocumentRoot "/var/www/html"
    replace: DocumentRoot "{{ document_root }}"
  notify: restart httpd

- name: DocumentRootのディレクトリ設定がされていること
  replace:
    dest: /etc/httpd/conf/httpd.conf
    regexp: <Directory "/var/www/html">
    replace: <Directory "{{ document_root }}">
  notify: restart httpd

- name: .htaccessが有効になっていること
  replace:
    dest: /etc/httpd/conf/httpd.conf
    regexp: 'AllowOverride None'
    replace: 'AllowOverride All'
  notify: restart httpd

# PHP
- name: PHPとPHP関連モジュールがインストールされていること
  yum:
    name:
      - php71
      - php71-mysqlnd
      - php71-mbstring
      - php71-pdo
      - php71-bcmath
    state: present
  notify: restart httpd

# いろいろ挑戦したものの、AWSLinuxでcentOS7用のmysqlを設定しようとするとエラー
- name: リポジトリ追加
  yum:
    name: https://dev.mysql.com/get/mysql80-community-release-el7-1.noarch.rpm
    state: present

- name: mysql8.0リポジトリの無効化
  shell: 'yum-config-manager --disable mysql80-community'

- name: mysql8.0削除
  yum:
    name: mysql-community-common
    state: absent

- name: mysql5.7リポジトリの有効化
  shell: 'yum-config-manager --enable mysql57-community'

- name: mysqlインストール
  yum:
    name: mysql-community-server
    state: present

# mysql
#- name: MySQL本体と依存関係のあるプログラムがインストールされていること
#  yum:
#    name: mysql{{mysql_version}}-server
#    state: present

# Mysql-pythonのインストールがうまくいかないため、mysqlの設定は手動で行うものとする
#- name: Mysql-pythonがインストールされていること
#  yum:
#    name:
#      - libselinux-python
#      - python
#      - python-pip
#      - python-devel
#    state: present
#
#- name: Mysql-pythonがインストールされていること
#  pip:
#    name:
#      - mysqlclient
#      - MySQL-python

- name: MySQLサービスが自動起動すること
  service:
    name: mysqld
    enabled: yes
    state: started

- name: データディレクトリが初期化済であること
  stat: path=/var/lib/mysql_initialized
#  register: mysql_initialized_stat
#  changed_when: not mysql_initialized_stat.stat.exists

#- name: root アカウントのパスワードを設定
#  mysql_user:
#    name: root
#    host: localhost
#    password: "{{ db_pass }}"

#- name: ~/.my.cnf を配置
#  template:
#    src: my.cnf.j2
#    dest: "{{ lookup('env', 'HOME') }}/.my.cnf"
#    mode: 0600

#- name: 開発用DBの作成
#  mysql_db: db={{ db_name }} state=present encoding=utf8mb4
#
#- name: MySQL開発DBアカウントの作成
#  mysql_user:
#    name: "{{ db_user }}"
#    password: "{{ db_pass }}"
#    host: "127.0.0.1"
#    priv: "*.*:ALL"
#    append_privs: yes
#    state: present

#CREATE USER study@localhost IDENTIFIED BY 'xxx';
#GRANT ALL PRIVILEGES ON study .* TO study@localhost IDENTIFIED BY 'xxx';
#CREATE DATABASE study CHARACTER SET utf8mb4;

# タイムゾーン設定
- name: timezoneが「Asia/Tokyo」となっていること
  timezone:
    name: Asia/Tokyo

# コンポーザー
# TODO:warningの解消（URL指定のせい？現状インストールは成功するので後回し）
- name: composerがインストールされていること
  shell: curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/bin && mv /usr/bin/composer.phar /usr/bin/composer
    creates=/usr/bin/composer

- include: local.yml
  when: not is_production

- include: production.yml
  when: is_production